<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dentodesk - Agenda</title>
  <link rel="stylesheet" href="estilos.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <!-- Barra superior -->
  <header class="navbar">
    <div class="user-info">
  Bienvenido, <span id="nombrePaciente"></span>
  <button onclick="cerrarSesion()">Cerrar sesi√≥n</button>
</div>

    <div class="logo">Dentodesk</div>
    <nav class="nav-links">
      <a href="index.html">Agenda</a>
      <a href="pacientes.html">Pacientes</a>
      <a href="caja.html">Caja</a>
      <a href="marketing.html">Marketing</a>
      <a href="produccion.html">Producci√≥n</a>
      <a href="inventario.html">Inventario</a>
      <a href="laboratorio.html" class="active">Laboratorio</a>
      <a href="chat.html">Chat</a>
    </nav>
    <div class="actions">
      <button class="main-btn" id="btnRegistrarCita"><i class="fa-solid fa-calendar-plus"></i> Registrar cita</button>
      <div class="user-menu">
        <button class="user-btn">üë§ ‚åÑ</button>
        <div class="dropdown hidden">
          <a href="#">Mi perfil</a>
          <a href="#">Cerrar sesi√≥n</a>
        </div>
      </div>
      <div class="search-bar">
        <input type="text" placeholder="Buscar paciente">
        <button>üîç</button>
      </div>
    </div>
  </header>

  <!-- Contenido principal -->
  <main class="agenda-container">
    <!-- Encabezado de navegaci√≥n -->
    <div class="agenda-header">
      <button class="nav-btn" id="prevBtn">‚Üê</button>
      <button class="nav-btn" id="nextBtn">‚Üí</button>
      <button class="hoy-btn" id="hoyBtn">üìÖ Hoy</button>
      <span class="rango-fechas" id="rangoFechas"></span>
    </div>

    <!-- Filtros -->
    <div class="filtros">
      <label>Estado
        <select id="filtroEstado">
          <option value="Todos">Todos</option>
          <option value="Confirmado">Confirmados</option>
          <option value="Pendiente">Pendientes</option>
          <option value="Cancelado">Cancelados</option>
        </select>
      </label>
      <label>Vista
        <select id="vistaSelect">
          <option value="semana">Por semana</option>
          <option value="dia">Por d√≠a</option>
          <option value="mes">Por mes</option>
        </select>
      </label>
    </div>

    <!-- Agenda + Sidebar -->
    <div class="agenda-wrapper">
      <!-- Agenda -->
      <div class="agenda-grid">
        <div class="agenda-hours" id="agendaHours"></div>
        <div class="agenda-days" id="agendaDays"></div>
        <div class="agenda-cells" id="agendaCells"></div>
      </div>

      <!-- Sidebar lateral -->
      <aside class="agenda-sidebar">
        <h3>üìã Todas las agendas</h3>
        <div class="agenda-list" id="agendaList">
          <div class="agenda-item color-azul"><span class="nombre">‚úîÔ∏è LUIS SILVA</span></div>
          <div class="agenda-item color-rojo"><span class="nombre">‚úîÔ∏è Especialistas</span></div>
        </div>
        <button class="main-btn full-width" id="btnAgregarAgenda">+ Agregar</button>
      </aside>
    </div>
  </main>

  <!-- Modal Registrar Cita -->
<div id="modalCita" class="modal hidden">
  <div class="modal-content">
    <span class="close-btn" id="cerrarModal">&times;</span>
    <h2>Registrar nueva cita</h2>

    <!-- Pesta√±as -->
    <div class="tabs">
      <button type="button" class="tab-btn active" data-tab="tab-cita">üóì Cita</button>
      <button type="button" class="tab-btn" data-tab="tab-paciente">üë§ Datos Personales</button>
    </div>

    <!-- Contenido de pesta√±as -->
    <div class="tab-content active" id="tab-cita">
      <form id="formCita">
        <label>Paciente:
          <input type="text" id="paciente" required>
        </label>
        <label>Fecha:
          <input type="date" id="fecha" required>
        </label>

        <label for="hora">Hora:</label>
        <select id="hora" required>
            <option value="09:00">09:00 AM</option>
            <option value="10:00">10:00 AM</option>
            <option value="11:00">11:00 AM</option>
            <option value="12:00">12:00 PM</option>
            <option value="13:00">01:00 PM</option>
            <option value="14:00">02:00 PM</option>
            <option value="15:00">03:00 PM</option>
            <option value="16:00">04:00 PM</option>
            <option value="17:00">05:00 PM</option>
            <option value="18:00">06:00 PM</option>
            <option value="19:00">07:00 PM</option>
            <option value="20:00">08:00 PM</option>
        </select>

        <label>Estado:
          <select id="estado">
            <option value="Confirmado">Confirmado</option>
            <option value="Pendiente">Pendiente</option>
            <option value="Cancelado">Cancelado</option>
          </select>
        </label>
        <label>Observaciones:
          <textarea id="observaciones"></textarea>
        </label>
        <button type="submit" class="main-btn">Guardar cita</button>
      </form>
    </div>

    <div class="tab-content" id="tab-paciente">
      <form id="formPaciente">
        <label>Apellidos y Nombres:
          <input type="text" id="nombres" required>
        </label>
        <label>Representante:
          <input type="text" id="representante">
        </label>
        <label>Edad:
          <input type="number" id="edad" min="0">
        </label>
        <label>DNI:
          <input type="text" id="dni" maxlength="8">
        </label>
        <label>G√©nero:
          <select id="genero">
            <option value="F">F</option>
            <option value="M">M</option>
          </select>
        </label>
        <label>Fecha de Nacimiento:
          <input type="date" id="fechaNacimiento">
        </label>
        <label>Direcci√≥n:
          <input type="text" id="direccion">
        </label>
        <label>Estado Civil:
          <select id="estadoCivil">
            <option value="S">S</option>
            <option value="C">C</option>
            <option value="V">V</option>
          </select>
        </label>
        <label>Peso (kg):
          <input type="number" id="peso" step="0.1">
        </label>
        <label>Talla (cm):
          <input type="number" id="talla">
        </label>
        <label>Presi√≥n Arterial:
          <input type="text" id="presionArterial" placeholder="120/80">
        </label>
        <label>Frecuencia Respiratoria:
          <input type="number" id="frecuenciaRespiratoria">
        </label>
        <label>Temperatura (¬∞C):
          <input type="number" id="temperatura" step="0.1">
        </label>
        <fieldset>
          <legend>Tipo de Paciente:</legend>
          <label><input type="checkbox" name="tipoPaciente" value="Receptivo"> Receptivo</label>
          <label><input type="checkbox" name="tipoPaciente" value="Pasivo"> Pasivo</label>
          <label><input type="checkbox" name="tipoPaciente" value="Hist√©rico"> Hist√©rico</label>
          <label><input type="checkbox" name="tipoPaciente" value="Esc√©ptico"> Esc√©ptico</label>
        </fieldset>
        <fieldset>
          <legend>Apreciaci√≥n General:</legend>
          <label><input type="radio" name="apreciacion" value="ABEG1"> ABEG</label>
          <label><input type="radio" name="apreciacion" value="ABEG2"> ABEG</label>
          <label><input type="radio" name="apreciacion" value="ABEG3"> ABEG</label>
          <label><input type="radio" name="apreciacion" value="AMEG"> AMEG</label>
        </fieldset>
        <button type="submit" class="main-btn">Guardar Datos</button>
      </form>
    </div>
  </div>
</div>

  <!-- Scripts -->
  <script>

      // ================= CONTROL DE ACCESO =================
    const usuarioActivo = localStorage.getItem("usuarioActivo");
    if (!usuarioActivo) {
      window.location.href = "login.html"; // Si no hay sesi√≥n activa, regresar al login
    }

    // Obtener datos del usuario
    const usuarios = JSON.parse(localStorage.getItem("usuarios")) || {};
    const paciente = usuarios[usuarioActivo];
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("nombrePaciente").textContent = paciente?.nombre || "Paciente";
    });

    // Funci√≥n cerrar sesi√≥n
    function cerrarSesion() {
      localStorage.removeItem("usuarioActivo");
      window.location.href = "login.html";
    } 


    document.addEventListener("DOMContentLoaded", () => {
      const agendaHours = document.getElementById("agendaHours");
      const agendaCellsContainer = document.getElementById("agendaCells");
      const agendaDays = document.getElementById("agendaDays");
      const rangoFechas = document.getElementById("rangoFechas");
      const vistaSelect = document.getElementById("vistaSelect");

      // ================= GENERAR HORAS =================
      function generarHoras(inicio=9, fin=20){
        agendaHours.innerHTML="";
        for(let h=inicio; h<fin; h++){
          const div=document.createElement("div");
          div.textContent=(h<=12? h : h-12)+" "+(h<12?"a. m.":"p. m.");
          agendaHours.appendChild(div);
        }
      }

      function formatearHora(hora24) {
        let [hora, minutos] = hora24.split(":");
        hora = parseInt(hora, 10);
        const ampm = hora >= 12 ? "PM" : "AM";
        hora = hora % 12 || 12; // convierte 0 en 12
        return `${hora}:${minutos} ${ampm}`;
      }


      // ================= VISTA =================
      let currentDate = new Date();
      let vista = "semana";

      function renderVista(){
        agendaDays.innerHTML="";
        agendaCellsContainer.innerHTML="";
        if(vista==="semana"){
          generarHoras(9,21);
          renderSemana();
        }else if(vista==="dia"){
          generarHoras(9,21);
          renderDia();
        }else{
          generarHoras(); // vac√≠o en mes
          renderMes();
        }
         mostrarCitas(); // üîë SIEMPRE recargar citas al renderizar
      }

      // ================= SEMANA =================
      function getStartOfWeek(date){
        const d=new Date(date);
        const day=d.getDay();
        const diff=d.getDate()-day+(day===0?-6:1);
        return new Date(d.setDate(diff));
      }
      function renderSemana(){
        const start=getStartOfWeek(currentDate);
        const dias=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];
        const end=new Date(start);
        end.setDate(end.getDate()+6);
        rangoFechas.textContent=`${start.getDate()} ${start.toLocaleString("es-ES",{month:"short"})} - ${end.getDate()} ${end.toLocaleString("es-ES",{month:"short"})}`;
        agendaDays.style.gridTemplateColumns="repeat(7,1fr)";
        for(let i=0;i<7;i++){
          const dia=new Date(start);
          dia.setDate(start.getDate()+i);
          const div=document.createElement("div");
          div.innerHTML=`${dias[i]}<span>${dia.getDate()}/${dia.getMonth()+1}</span>`;
          agendaDays.appendChild(div);
        }
        agendaCellsContainer.style.gridTemplateColumns="repeat(7,1fr)";
        agendaCellsContainer.style.gridTemplateRows="repeat(12,1fr)";
        for(let fila=0;fila<12;fila++){
          for(let col=0;col<7;col++){
            const cell=document.createElement("div");
            cell.classList.add("cell");
            agendaCellsContainer.appendChild(cell);
          }
        }
        mostrarCitas();
      }

      // ================= DIA =================
      function renderDia(){
        rangoFechas.textContent=currentDate.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"short"});
        agendaDays.style.gridTemplateColumns="1fr";
        const div=document.createElement("div");
        div.textContent=currentDate.toLocaleDateString("es-ES",{weekday:"long"});
        agendaDays.appendChild(div);
        agendaCellsContainer.style.gridTemplateColumns="1fr";
        agendaCellsContainer.style.gridTemplateRows="repeat(12,1fr)";
        for(let fila=0;fila<12;fila++){
          const cell=document.createElement("div");
          cell.classList.add("cell");
          agendaCellsContainer.appendChild(cell);
        }
        mostrarCitas();
      }

      // ================= MES =================
      function renderMes(){
        rangoFechas.textContent=currentDate.toLocaleString("es-ES",{month:"long",year:"numeric"});
        agendaDays.style.gridTemplateColumns="repeat(7,1fr)";
        const dias=["L","M","X","J","V","S","D"];
        dias.forEach(d=>{let div=document.createElement("div");div.textContent=d;agendaDays.appendChild(div);});
        agendaCellsContainer.style.gridTemplateColumns="repeat(7,1fr)";
        agendaCellsContainer.style.gridTemplateRows="repeat(6,1fr)";
        let primer=new Date(currentDate.getFullYear(),currentDate.getMonth(),1);
        let start=new Date(primer);
        start.setDate(primer.getDate()-(primer.getDay()||7)+1);
        for(let i=0;i<42;i++){
          const d=new Date(start);
          d.setDate(start.getDate()+i);
          const cell=document.createElement("div");
          cell.classList.add("cell");
          cell.dataset.dia=d.getDate();
          cell.textContent=d.getDate();
          if(d.getMonth()!==currentDate.getMonth()){cell.style.color="#aaa";}
          agendaCellsContainer.appendChild(cell);
        }
        mostrarCitas();
      }

      // ================= BOTONES NAVEGACI√ìN =================
      document.getElementById("prevBtn").addEventListener("click",()=>{
        if(vista==="semana") currentDate.setDate(currentDate.getDate()-7);
        else if(vista==="dia") currentDate.setDate(currentDate.getDate()-1);
        else currentDate.setMonth(currentDate.getMonth()-1);
        renderVista();
      });
      document.getElementById("nextBtn").addEventListener("click",()=>{
        if(vista==="semana") currentDate.setDate(currentDate.getDate()+7);
        else if(vista==="dia") currentDate.setDate(currentDate.getDate()+1);
        else currentDate.setMonth(currentDate.getMonth()+1);
        renderVista();
      });
      document.getElementById("hoyBtn").addEventListener("click",()=>{
        currentDate=new Date();
        renderVista();
      });
      vistaSelect.addEventListener("change",e=>{vista=e.target.value;renderVista();});

      // ================= MODAL =================
      const modal=document.getElementById("modalCita");
      document.getElementById("btnRegistrarCita").addEventListener("click",()=>modal.classList.remove("hidden"));
      document.getElementById("cerrarModal").addEventListener("click",()=>modal.classList.add("hidden"));
      window.addEventListener("click",(e)=>{if(e.target===modal)modal.classList.add("hidden");});

      // ================= AGREGAR AGENDA =================
      document.getElementById("btnAgregarAgenda").addEventListener("click",()=>{
        const nombre=prompt("Nombre de la nueva agenda:");
        if(nombre){
          const div=document.createElement("div");
          div.classList.add("agenda-item","color-azul");
          div.innerHTML=`<span class="nombre">‚úîÔ∏è ${nombre}</span>`;
          document.getElementById("agendaList").appendChild(div);
        }
      });

      // ================= DROPDOWN USUARIO =================
      document.querySelector(".user-btn").addEventListener("click",()=>{
        document.querySelector(".dropdown").classList.toggle("hidden");
      });

      // ================= GUARDAR Y MOSTRAR CITAS =================
      function mostrarCitas(){
        const citas=JSON.parse(localStorage.getItem("citas"))||[];
        agendaCellsContainer.querySelectorAll(".cell").forEach(c=>{
          if(vista!=="mes"){ 
            c.innerHTML="";
          } else {
            let numeroDia=c.dataset.dia;
            c.innerHTML=numeroDia?numeroDia:"";
          }
        });

        citas.forEach(cita=>{
          const fecha=new Date(cita.fecha+"T"+cita.hora);

          if(vista==="semana"){
            const start=getStartOfWeek(currentDate);
            const end=new Date(start);end.setDate(end.getDate()+6);
            if(fecha>=start && fecha<=end){
              const dia=fecha.getDay()===0?6:fecha.getDay()-1;
              const fila=fecha.getHours()-9;
              if(fila>=0 && fila<12){
                const index=fila*7+dia;
                const cell=agendaCellsContainer.children[index];
                const div=document.createElement("div");
                div.classList.add("cita");
                div.textContent = `${cita.paciente} (${formatearHora(cita.hora)})`;
                cell.appendChild(div);
              }
            }
          }else if(vista==="dia"){
            if(fecha.toDateString()===currentDate.toDateString()){
              const fila=fecha.getHours()-9;
              if(fila>=0 && fila<12){
                const cell=agendaCellsContainer.children[fila];
                const div=document.createElement("div");
                div.classList.add("cita");
                div.textContent = `${cita.paciente} (${formatearHora(cita.hora)})`;
                cell.appendChild(div);
              }
            }
          }else if(vista==="mes"){
            agendaCellsContainer.querySelectorAll(".cell").forEach(cell=>{
              const numeroDia=parseInt(cell.dataset.dia);
              const cellDate=new Date(currentDate.getFullYear(),currentDate.getMonth(),numeroDia);
              if(cell.style.color!=="rgb(170, 170, 170)" && fecha.toDateString()===cellDate.toDateString()){
                const div=document.createElement("div");
                div.classList.add("cita");
                div.textContent = `${cita.paciente} (${formatearHora(cita.hora)})`;
                cell.appendChild(div);
              }
            });
          }
        });
      }

      document.getElementById("formCita").addEventListener("submit",(e)=>{
        e.preventDefault();
        const paciente=document.getElementById("paciente").value;
        const fecha=document.getElementById("fecha").value;
        const hora=document.getElementById("hora").value;
        const estado=document.getElementById("estado").value;
        const observaciones=document.getElementById("observaciones").value;

        let citas=JSON.parse(localStorage.getItem("citas"))||[];
        citas.push({paciente,fecha,hora,estado,observaciones});
        localStorage.setItem("citas",JSON.stringify(citas));

        // guardar tambi√©n en pacientes
        let pacientes=JSON.parse(localStorage.getItem("pacientes"))||[];
        pacientes.push({paciente,fecha,hora,estado,observaciones});
        localStorage.setItem("pacientes",JSON.stringify(pacientes));

        modal.classList.add("hidden");
        e.target.reset();
        renderVista();
      });

      // ================= TABS DEL MODAL =================
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

// ================= GUARDAR DATOS PACIENTE =================
document.getElementById("formPaciente").addEventListener("submit",(e)=>{
  e.preventDefault();
  const datos = {
    nombres: document.getElementById("nombres").value,
    representante: document.getElementById("representante").value,
    edad: document.getElementById("edad").value,
    dni: document.getElementById("dni").value,
    genero: document.getElementById("genero").value,
    fechaNacimiento: document.getElementById("fechaNacimiento").value,
    direccion: document.getElementById("direccion").value,
    estadoCivil: document.getElementById("estadoCivil").value,
    peso: document.getElementById("peso").value,
    talla: document.getElementById("talla").value,
    presionArterial: document.getElementById("presionArterial").value,
    frecuenciaRespiratoria: document.getElementById("frecuenciaRespiratoria").value,
    temperatura: document.getElementById("temperatura").value,
    tipoPaciente: [...document.querySelectorAll("input[name='tipoPaciente']:checked")].map(el=>el.value),
    apreciacion: document.querySelector("input[name='apreciacion']:checked")?.value || ""
  };

  let pacientes = JSON.parse(localStorage.getItem("pacientes")) || [];
  pacientes.push(datos);
  localStorage.setItem("pacientes", JSON.stringify(pacientes));

  alert("‚úÖ Datos personales guardados correctamente");
  e.target.reset();
});


      // ================= INICIALIZAR =================
      renderVista();
    });
  </script>
</body>
</html>
